<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>游戏进度管理</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            height: 100vh;
            overflow: hidden;
            position: relative;
            background: linear-gradient(rgba(0, 0, 0, 0.4), rgba(0, 0, 0, 0.4)), url('../assets/bg/bg.jpg') center center/cover no-repeat;
            display: flex;
            justify-content: center;
        }
        
        .container {
            width: 75%;
            margin-top: 70px; /* 为固定顶部菜单留出空间 */
            margin-left: auto;
            margin-right: auto;
            background: transparent;
            padding: 15px;
            border-radius: 8px;
            box-shadow: none;
        }
        
        h1 {
            color: #FFD700;
            text-align: center;
            margin: 40px auto 20px auto;
            font-size: 32px;
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            width: fit-content;
        }
        
        .jump-section {
            margin: 15px 0;
        }
        
        h2 {
            margin: 20px auto 15px auto;
            color: #FFD700;
            font-size: 18px;
            text-shadow: 0 0 5px rgba(255, 215, 0, 0.8);
            width: fit-content;
            text-align: center;
        }
        
        .scene-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }
        
        .scene-card {
            background-color: transparent;
            border: 1px solid #4CAF50;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
            min-height: 60px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }
        
        .scene-card button {
            background-color: rgba(33, 150, 243, 0.8);
            color: white;
            padding: 8px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 8px;
            width: 100%;
        }
        
        .scene-card button:hover {
            background-color: #1976D2;
        }
        
        .actions {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 1000;
            text-align: center;
            margin: 0;
            padding: 10px;
            border: none;
            border-bottom: 1px solid #FFD700;
            background-color: transparent;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 10px;
        }
        
        .container {
            width: 75%;
            margin-top: 70px; /* 为固定顶部菜单留出空间 */
            margin-left: auto;
            margin-right: auto;
            background: transparent;
            padding: 15px;
            border-radius: 8px;
            box-shadow: none;
        }
        
        button {
            background-color: transparent;
            color: #FFD700;
            padding: 8px 16px;
            border: 2px solid #FFD700;
            border-radius: 20px;
            cursor: pointer;
            margin: 0 5px;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background-color: rgba(255, 215, 0, 0.2);
            color: #FFA500;
            border: 2px solid #FFA500;
        }
        
        button.delete {
            color: #f44336;
            border: 2px solid #f44336;
        }
        
        button.delete:hover {
            background-color: rgba(244, 67, 54, 0.2);
            color: #da190b;
            border: 2px solid #da190b;
        }
        
        .status {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
            text-align: center;
            font-size: 14px;
        }
        
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        /* 隐藏游戏相关元素 */
        #background-container,
        #character-container,
        #text-box-container,
        #options-container,
        #novel-mode-container {
            display: none;
        }
        
        /* 音频播放器保持隐藏 */
        audio {
            display: none;
        }
    </style>
</head>
<body>
    <!-- 背景容器 - 用作菜单背景 -->
    <div id="background-container"></div>
    
    <!-- 角色立绘容器 -->
    <div id="character-container"></div>
    
    <!-- 文本框区域 -->
    <div id="text-box-container">
        <div id="name-box">[姓名]</div>
        <div id="text-box">[文本]</div>
    </div>
    
    <!-- 选项容器 -->
    <div id="options-container"></div>
    
    <!-- 全屏文本模式 -->
    <div id="novel-mode-container">
        <div id="novel-text-box">[全屏文本]</div>
    </div>
    
    <!-- 音频播放器 -->
    <audio id="bgm-player" loop></audio>
    <audio id="se-player"></audio>
    <audio id="voice-player"></audio>
    
    
    <div class="container">
        
        <div class="actions">
            <button onclick="loadProgress()">刷新进度</button>
            <button onclick="exportSave()" class="export">导出存档</button>
            <button onclick="resetProgress()" class="delete">重置进度</button>
            <button id="return-current-story" style="display:none;" onclick="returnToCurrentStory()">返回当前剧情（这将会返回到你进入此页面的html页面剧情的开始）</button>
            <button onclick="location.href='../index.html'" class="back">返回主菜单(esc)</button>
        </div>
        
        <h1 id="page-title">游戏进度管理</h1>
        
        <div class="jump-section">
            <h2>快速跳转</h2>
            <div id="quick-jump-grid" class="scene-grid">
                <!-- 动态加载可跳转的场景按钮 -->
            </div>
        </div>
        
        <div id="status-message" class="status" style="display: none;"></div>
    </div>

    <script>
        // 存档管理器
        const SaveManager = {
            // 加载进度数据
            loadProgress: function() {
                const progressData = localStorage.getItem('gameProgress');
                if (progressData) {
                    try {
                        return JSON.parse(progressData);
                    } catch (e) {
                        console.error('加载进度失败:', e);
                        this.showMessage('加载进度失败', 'error');
                        return null;
                    }
                }
                return null;
            },
            
            // 获取所有场景列表
            getAllScenes: function() {
                // 这里列出所有可能的scene文件
                return [
                    'scene1.html',
                    'scene2.html',
                    'scene3.html'
                ];
            },
            
            // 显示进度信息
            displayProgress: function() {
                const progressData = this.loadProgress();
                
                // 显示快速跳转按钮
                this.displayQuickJumpButtons(progressData);
            },
            
            // 导出存档
            exportSave: function() {
                const progressData = this.loadProgress();
                if (!progressData) {
                    this.showMessage('没有可导出的进度数据', 'error');
                    return;
                }
                
                // 创建下载链接
                const dataStr = JSON.stringify(progressData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `galgame_save_${new Date().toISOString().slice(0, 19)}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                linkElement.click();
                
                this.showMessage('存档已导出', 'success');
            },
            
            // 重置进度
            resetProgress: function() {
                if (confirm('确定要重置所有游戏进度吗？此操作不可撤销。')) {
                    localStorage.removeItem('gameProgress');
                    this.displayProgress();
                    this.showMessage('进度已重置', 'success');
                }
            },
            
            // 显示状态消息
            showMessage: function(message, type) {
                const statusDiv = document.getElementById('status-message');
                statusDiv.textContent = message;
                statusDiv.className = `status ${type}`;
                statusDiv.style.display = 'block';
                
                // 3秒后自动隐藏
                setTimeout(() => {
                    statusDiv.style.display = 'none';
                }, 3000);
            },
            
            // 显示快速跳转按钮
            displayQuickJumpButtons: function(progressData) {
                const jumpGrid = document.getElementById('quick-jump-grid');
                jumpGrid.innerHTML = '';
                
                if (progressData && progressData.sceneMarkers) {
                    const markers = progressData.sceneMarkers;
                    const markerKeys = Object.keys(markers);
                    
                    // 过滤出已访问的场景
                    const visitedScenes = markerKeys.filter(marker => markers[marker] === 1);
                    
                    if (visitedScenes.length > 0) {
                        visitedScenes.forEach(sceneId => {
                            const sceneFileName = `${sceneId}.html`;
                            
                            // 检查是否为有效的场景文件
                            if (this.isValidSceneFile(sceneFileName)) {
                                // 自定义场景名称映射 - 为每个HTML文件提供自定义名称
                                const sceneNames = {
                                    'scene1': '1初次相遇',
                                    'scene2': '1.2坏结局-见面虾头男',
                                    'scene3': '场景3 - 夜晚回忆',
                                    // 可以继续添加更多场景
                                    'scene4': '场景4',
                                    'scene5': '场景5',
                                    'scene6': '场景6',
                                    'scene7': '场景7',
                                    'scene8': '场景8',
                                    'scene9': '场景9',
                                    'scene10': '场景10',
                                    'ending1': '结局1',
                                    'ending2': '结局2',
                                    'ending3': '结局3',
                                    'sub_scene1': '分支场景1',
                                    'sub_scene2': '分支场景2',
                                    'sub_scene3': '分支场景3'
                                };
                                
                                const displayName = sceneNames[sceneId] || sceneId.replace(/_/g, ' ').replace('scene', '场景 ');
                                
                                const cardDiv = document.createElement('div');
                                cardDiv.className = 'scene-card';
                                cardDiv.innerHTML = `
                                    <div class="scene-name">${displayName}</div>
                                    <button onclick="SaveManager.jumpToScene('${sceneFileName}')">
                                        跳转
                                    </button>
                                `;
                                jumpGrid.appendChild(cardDiv);
                            }
                        });
                    } else {
                        jumpGrid.innerHTML = '<p style="text-align: center; color: #666;">还没有可以跳转的场景</p>';
                    }
                } else {
                    jumpGrid.innerHTML = '<p style="text-align: center; color: #666;">还没有可以跳转的场景</p>';
                }
            },
            
            // 检查是否为有效的场景文件
            isValidSceneFile: function(fileName) {
                // 只接受scene类型的文件，不包括index、bgm、video等
                const validSceneFiles = [
                    'scene1.html', 'scene2.html', 'scene3.html'
                ];
                
                // 检查文件名是否在有效列表中或符合scene开头的模式（但排除scene_开头的特殊页面如scene_demo）
                return validSceneFiles.includes(fileName) || 
                       (fileName.startsWith('scene') && 
                        !fileName.startsWith('scene_demo') && 
                        !fileName.startsWith('scene_'));
            },
            
            // 跳转到指定场景
            jumpToScene: function(sceneFileName) {
                // 确定场景文件路径
                let fullPath = '';
                
                // 处理不同类型的页面跳转
                if (sceneFileName === 'index.html') {
                    // 返回主菜单
                    fullPath = '../index.html';
                } else if (['saves.html', 'bgm.html', 'video.html'].includes(sceneFileName)) {
                    // 跳转到html目录下的页面
                    fullPath = './' + sceneFileName;
                } else if (!sceneFileName.includes('/')) {
                    // 跳转到scenes子目录下的场景文件
                    fullPath = '../scenes/' + sceneFileName;
                } else {
                    // 如果路径已包含目录信息，直接使用
                    fullPath = '../' + sceneFileName;
                }
                
                // 跳转到指定场景
                window.location.href = fullPath;
            }
        };
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            SaveManager.displayProgress();
        });
        
        // 全局函数
        function loadProgress() {
            SaveManager.displayProgress();
        }
        
        function exportSave() {
            SaveManager.exportSave();
        }
        
        function resetProgress() {
            SaveManager.resetProgress();
        }
        
        function returnToCurrentStory() {
            // 从sessionStorage获取上一个页面信息
            const lastPage = sessionStorage.getItem('lastStoryPage');
            if (lastPage) {
                window.location.href = lastPage;
            } else {
                // 如果没有记录，返回主菜单
                window.location.href = '../index.html';
            }
        }
        
        // 页面加载时检查是否从剧情页面跳转而来
        window.addEventListener('DOMContentLoaded', function() {
            const lastPage = sessionStorage.getItem('lastStoryPage');
            const referrer = document.referrer;
            
            // 检查是否来自剧情页面（非index.html）
            if (lastPage && !lastPage.endsWith('index.html') && 
                (!referrer || !referrer.endsWith('index.html'))) {
                // 显示返回当前剧情按钮
                const returnBtn = document.getElementById('return-current-story');
                if (returnBtn) {
                    returnBtn.style.display = 'inline-block';
                }
            }
        });
        
        // ESC键返回主菜单
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                window.location.href = '../index.html';
            }
        });
    </script>
</body>
</html>